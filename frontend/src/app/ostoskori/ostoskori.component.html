<!-- Tilauskomponentti (cart eli ostoskori) -->


<div class="min-h-screen py-8">
  <div class="max-w-6xl mx-auto px-4">
    <!-- Otsikko -->
    <h1 class="text-3xl font-bold text-gray-900 mb-8 text-center lg:text-left">
      Ostoskori
    </h1>

    <!-- P√§√§sis√§lt√∂ -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- VASEN - Tuotelista -->
      <div class="lg:col-span-2 space-y-6">
        <ng-container *ngFor="let product of getCartProductsWithDetails(); trackBy: trackByProduct">
          <!-- Klikattava tuotekortti -->
          <div
            class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all duration-300 cursor-pointer bg-white hover:bg-gray-50"
            (click)="goToProductNotification(product)">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
              <!-- Vasemmalle: Tuotekuva ja tiedot -->
              <div class="flex items-start sm:items-center gap-4 w-full">
                <!-- Tuotekuva -->
                <div
                  class="w-20 h-20 bg-gray-200 rounded-lg flex items-center justify-center flex-shrink-0 overflow-hidden">
                  <ng-container *ngIf="product.image">
                    <img [src]="product.image" alt="Tuotekuva" class="w-full h-full object-cover rounded-lg"
                      title="product.name" />
                  </ng-container>
                  <!-- <ng-template #noImage>
                    <span class="text-gray-400 text-2xl material-symbols-outlined">image</span>
                  </ng-template> -->
                </div>

                <!-- Tuotetiedot -->
                <div class="flex-1">
                  <h2 class="text-lg sm:text-xl font-semibold text-gray-900 mb-1">
                    {{ product.name }}
                  </h2>
                  <p *ngIf="product.producerName" class="text-sm text-gray-700 font-medium">
                    {{ product.producerName }}
                  </p>

                  <!-- <div class="flex flex-wrap gap-3 text-xs text-gray-500 mt-1">
                    <p *ngIf="product.id"><span class="font-medium">TuoteID:</span> {{ product.id }}</p>
                    <p *ngIf="product.notificationID"><span class="font-medium">IlmoitusID:</span> {{
                      product.notificationID }}</p>
                    <p *ngIf="product.producerID"><span class="font-medium">TuottajaID:</span> {{ product.producerID }}
                    </p>
                  </div> -->

                  <!-- M√Ñ√ÑR√Ñ GRAMMOINA -->
                  <p class="text-gray-700 mt-2 text-sm">
                    M√§√§r√§: {{ (product.amount / 500) | number:'1.0-0' }} kpl ({{ product.amount }}g)
                  </p>
                </div>
              </div>

              <!-- Oikealle: m√§√§r√§ ja hinta -->
              <div class="flex items-center justify-between sm:justify-end w-full sm:w-auto gap-4"
                (click)="$event.stopPropagation()">
                <!-- ROSKAKORI JA M√Ñ√ÑR√ÑN S√Ñ√ÑT√ñ -->
                <div class="flex items-center gap-3">
                  <!-- Roskakori - omassa laatikossa samalla tyylill√§ -->
                  <button (click)="ostoskoriService.removeFromCart(product.uniqueId)"
                    class="w-8 h-8 flex items-center justify-center border-2 border-green-600 rounded-lg bg-white transition-colors hover:bg-red-50">
                    <span class="text-lg material-symbols-outlined hover:text-red-800">delete</span>
                  </button>

                  <!-- M√§√§r√§n s√§√§t√∂ laatikko -->
                  <div
                    class="flex items-center border-2 border-green-600 rounded-lg bg-white hover:bg-gray-50 transition-colors">
                    <button (click)="ostoskoriService.decrement(product.uniqueId)"
                      class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 transition-colors rounded-l-lg"
                      [disabled]="product.amount <= 500" [class.opacity-50]="product.amount <= 500"
                      [class.cursor-not-allowed]="product.amount <= 500">
                      <span class="text-gray-700 text-lg material-symbols-outlined">remove</span>
                    </button>

                    <!-- <span
                      class="w-10 h-8 flex items-center justify-center text-gray-900 font-medium border-l border-r border-gray-300">
                      {{ product.amount / 500 | number:'1.0-0' }}
                    </span> -->
                    <input
                      class="w-10 h-8 flex items-center justify-center text-gray-900 font-medium border-l border-r border-gray-300 text-center"
                      title="tuoteMaaraControl" [value]="product.amount / 500"
                      [formControl]="maaraControl[product.uniqueId]"
                      (ngModelChange)="updateCartQuantity(product.uniqueId, $event)" />


                    <button (click)="ostoskoriService.increment(product.uniqueId)"
                      class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 transition-colors rounded-r-lg">
                      <span class="text-gray-700 text-lg material-symbols-outlined">add</span>
                    </button>
                  </div>
                </div>

                <!-- HINTA - KORJATTU SAMAAN TASOON -->
                <div class="flex flex-col items-end justify-center">
                  <!-- Kokonaishinta samalla tasolla kuin -1+ laatikko -->
                  <h2 class="text-lg font-semibold text-gray-900 whitespace-nowrap">
                    {{ getProductTotal(product) | number:'1.2-2' }} ‚Ç¨

                  </h2>
                  <!-- Yksikk√∂hinta samalla tasolla kuin /500g -->
                  <p class="text-xs text-gray-500 whitespace-nowrap">
                    {{ product.price }} ‚Ç¨/500g
                  </p>
                </div>
              </div>
            </div>
          </div>
        </ng-container>
      </div>



      <!--  -->

      <!-- OIKEA - Tilausyhteenveto -->
      <div class="lg:col-span-1 order-2 lg:order-2 bg-gray-50 rounded-lg p-6 h-fit lg:sticky lg:top-4"
        *ngIf="ostoskoriService.getItems().length > 0">

        <!-- Lis√§√§ t√§m√§: Mat-Select desktopissa (lg:) laatikon yl√§puolella -->
        <div class="mb-4">
          <h2 class="text-lg font-semibold text-gray-900 mb-2">Valitse noutopaikka</h2>
          <mat-form-field appearance="fill" class="w-full">
            <mat-label>Noutopaikka</mat-label>
            <mat-select [formControl]="pickupControl">
              <mat-option *ngFor=" let pickup of pulledPickupOptions" [value]="pickup.value">
                {{ pickup.viewValue }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <div *ngIf="pickupControl.touched && pickupControl.invalid" class="text-red-600 text-sm mt-1">
            Noutopaikka t√§ytyy valita!
          </div>
        </div>




        <h3 class="text-xl font-semibold text-gray-900 mb-4 text-center lg:text-left">Tilaus</h3>

        <!-- Yhteens√§ -->
        <div
          class="flex justify-between items-center mb-6 pb-4 border-b border-gray-200 text-gray-900 text-lg font-medium">
          <span>Yhteens√§:</span>
          <span class="text-xl font-semibold">
            {{ ostoskoriService.getTotalSum() | number:'1.2-2' }} ‚Ç¨
          </span>
        </div>

        <!-- Vahvistusnappi -->
        <button (click)="NoutoTiedotPakollinen()"
          class="w-full bg-[#80c783] text-black py-4 px-6 rounded-lg hover:bg-green-500 transition-colors font-semibold text-lg mb-4">
          Vahvista tilaus
        </button>

        <!-- Jatka ostamista -->
        <button [routerLink]="['/ilmoitukset']"
          class="w-full border border-gray-300 text-gray-700 py-3 px-6 rounded-lg hover:bg-gray-100 transition-colors font-medium">
          Jatka ostamista
        </button>
      </div>
    </div>

    <!-- TYHJ√Ñ OSTOSKORI -->
    <div *ngIf="ostoskoriService.getItems().length === 0" class="text-center py-16">
      <div class="text-8xl mb-6">üõí</div>
      <h2 class="text-2xl font-bold text-gray-900 mb-4">Ostoskori on tyhj√§</h2>
      <p class="text-gray-600 mb-8 max-w-md mx-auto">
        Lis√§√§ tuotteita ostoskoriin jatkaaksesi ostoksia.
      </p>
      <button [routerLink]="['/ilmoitukset']"
        class="px-8 py-4 bg-[#80c783] text-black rounded-lg hover:bg-green-500 transition-colors text-lg">
        Selaa tuotteita
      </button>
    </div>
  </div>

  <!-- VAHVISTUS-IKKUNA - Kuvan mukainen -->
  @if (showConfirmation) {
  <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-auto">

      <!-- Sis√§lt√∂ -->
      <div class="p-8 text-center">
        <!-- Checkmark-ikoni -->
        <div class="text-green-600 text-6xl mb-6">
          <span class="material-symbols-outlined text-6xl">check_circle</span>
        </div>

        <!-- Viesti -->
        <h3 class="text-xl font-semibold text-gray-900 mb-4">
          Tilauksesi on vahvistettu!
        </h3>

        <p class="text-gray-600 mb-2">
          Kiitos tilauksestasi
        </p>

        <!-- Sulje-nappi -->
        <button (click)="closeConfirmation()"
          class="w-full bg-[#80c783] text-black py-3 px-6 rounded-lg hover:bg-green-500 transition-colors font-semibold">
          Sulje
        </button>
      </div>
    </div>
  </div>
  }


</div>